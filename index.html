<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Infiltra™ Web Flasher</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json"/>
  <meta name="theme-color" content="#0a192f"/>
  <link rel="icon" href="icon-192.png"/>

  <!-- ESP Web Tools (Web Serial wrapper) -->
  <script type="module" src="https://unpkg.com/esp-web-tools@10.1.0/dist/web/install-button.js?module"></script>

  <style>
    :root{
      --bg1:#0a192f;--bg2:#112240;--fg:#e6f1ff;--muted:#8892b0;--brand:#64ffda;--card:rgba(17,34,64,.9);
      --blue:#3b82f6;--blue-strong:#2563eb;--outline:rgba(100,255,218,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg,var(--bg1),var(--bg2)); color:var(--fg);
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .app{width:100%; max-width:980px}
    .brand{ text-align:center; margin-bottom:20px}
    .brand h1{margin:0; font-size:32px; color:var(--blue)}
    .brand p{margin:6px 0 0; color:var(--muted)}

    .gate, .card{
      background:var(--card); border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,.45);
      border:1px solid var(--outline);
    }
    .gate{
      padding:28px; max-width:560px; margin:0 auto; text-align:center;
      display:none;
    }
    .gate h2{margin:0 0 12px; color:var(--brand)}
    .gate p{color:var(--fg); opacity:.9}
    .row{display:flex; gap:18px; flex-wrap:wrap}
    .col{flex:1 1 320px}

    .card{padding:20px}
    .section-title{margin:0 0 12px; color:var(--brand); font-size:18px}

    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px}
    .tab{
      border:1px solid var(--outline); background:#0f203f; color:var(--fg);
      padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:600;
      transition:.15s transform, .15s background;
    }
    .tab.active{background:var(--blue); border-color:transparent; color:#fff}
    .tab:hover{transform:translateY(-1px)}

    .device-list{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:12px}
    .device{
      border:1px solid var(--outline); border-radius:14px; padding:12px; background:#0d1c36;
    }
    .device h4{margin:0 0 6px}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700}
    .pill.soon{background:#1f2b43; color:#9fb3d1; border:1px dashed #2f415f}
    .pill.ready{background:#0f5132; color:#a8ffce}

    select, button{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--outline);
      background:#0f203f; color:var(--fg); font-weight:600;
    }
    button.primary{
      background:var(--blue); border:0; color:#fff; cursor:pointer;
      transition:.15s transform, .15s filter;
    }
    button.primary:hover{transform:translateY(-1px); filter:brightness(1.05)}
    button.primary:disabled{opacity:.6; cursor:not-allowed}

    .footer{margin-top:16px; text-align:center; color:var(--muted); font-size:12px}
    .hint{font-size:12px; color:var(--muted); margin-top:8px}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="app">

    <!-- Brand -->
    <div class="brand">
      <h1>Infiltra™ Web Flasher</h1>
      <p>Modern ESP flasher • PWA • Web Serial</p>
    </div>

    <!-- PWA Install Gate -->
    <div id="installGate" class="gate">
      <h2>Install to continue</h2>
      <p>For the best experience and to enable device flashing, please install Infiltra™ as an app.</p>
      <div class="row" style="margin-top:12px">
        <div class="col">
          <button id="installBtn" class="primary">Install Infiltra™</button>
          <div class="hint">If you don’t see a prompt, use your browser menu → <em>Add to Home screen</em>.</div>
        </div>
      </div>
    </div>

    <!-- Main UI -->
    <div id="mainUI" class="card hidden">
      <div class="row">
        <!-- Left: Categories & devices -->
        <div class="col">
          <h3 class="section-title">Choose Category</h3>
          <div id="tabs" class="tabs"></div>

          <div class="device-list" id="deviceList"></div>
        </div>

        <!-- Right: Flash panel -->
        <div class="col">
          <h3 class="section-title">Flash Firmware</h3>

          <label for="deviceSelect" class="hint">Device / Manifest</label>
          <select id="deviceSelect">
            <!-- populated by JS -->
          </select>

          <div class="hint">Note: Entries marked <b>Coming soon</b> are placeholders and not yet available.</div>

          <div style="margin-top:14px">
            <esp-web-install-button id="flashBtn" manifest="">
              <button class="primary" slot="activate" id="flashActivate">Flash Infiltra™</button>
            </esp-web-install-button>
          </div>

          <div class="footer">© 2025 Infiltra™ — Built with ESP Web Tools</div>
        </div>
      </div>
    </div>

  </div>

  <script>
    /********** PWA Service Worker **********/
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js");
    }

    /********** PWA Install Barrier **********/
    let deferredPrompt = null;
    const installGate = document.getElementById("installGate");
    const mainUI = document.getElementById("mainUI");
    const installBtn = document.getElementById("installBtn");

    // isStandalone: Chrome/Edge (display-mode) + iOS Safari (navigator.standalone)
    const isStandalone = () =>
      window.matchMedia("(display-mode: standalone)").matches ||
      window.navigator.standalone === true;

    const updateGate = () => {
      if (isStandalone()) {
        installGate.style.display = "none";
        mainUI.classList.remove("hidden");
      } else {
        installGate.style.display = "block";
        mainUI.classList.add("hidden");
      }
    };
    updateGate();

    window.addEventListener("appinstalled", () => {
      deferredPrompt = null;
      updateGate();
    });

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    installBtn.addEventListener("click", async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
      } else {
        alert("Use your browser menu → Add to Home screen.");
      }
    });

    /********** Categories & devices (Coming soon placeholders) **********/
    const categories = [
      { id:"m5stack",  label:"M5Stack" },
      { id:"lilygo",   label:"Lilygo" },
      { id:"esp",      label:"ESP Generic" },
      { id:"headless", label:"Headless" },
      { id:"custom",   label:"Custom" }
    ];

    // Each category has one example entry; only one (M5StickC Plus 2) is wired to a sample manifest.
    const catalog = {
      m5stack: [
        { name:"M5StickC Plus 2", version:"v1.0.0", status:"ready", manifest:"bin/m5stickcplus2.json" },
        { name:"M5StickC Plus 1", version:"Coming soon", status:"soon" }
      ],
      lilygo: [
        { name:"T-Display S3", version:"Coming soon", status:"soon" }
      ],
      esp: [
        { name:"ESP32 Generic", version:"Coming soon", status:"soon" }
      ],
      headless: [
        { name:"ESP32 Headless", version:"Coming soon", status:"soon" }
      ],
      custom: [
        { name:"Custom Board", version:"Coming soon", status:"soon" }
      ]
    };

    const tabsEl = document.getElementById("tabs");
    const deviceListEl = document.getElementById("deviceList");
    const deviceSelect = document.getElementById("deviceSelect");
    const flashBtn = document.getElementById("flashBtn");
    const flashActivate = document.getElementById("flashActivate");

    let activeCat = "m5stack";

    function renderTabs(){
      tabsEl.innerHTML = "";
      categories.forEach(cat=>{
        const b = document.createElement("button");
        b.className = "tab" + (cat.id===activeCat ? " active":"");
        b.textContent = cat.label;
        b.onclick = ()=>{ activeCat = cat.id; renderTabs(); renderDevices(); syncSelect(); };
        tabsEl.appendChild(b);
      });
    }

    function renderDevices(){
      deviceListEl.innerHTML = "";
      (catalog[activeCat]||[]).forEach(item=>{
        const div = document.createElement("div");
        div.className = "device";
        div.innerHTML = `
          <h4>${item.name}</h4>
          <div class="pill ${item.status==='soon'?'soon':'ready'}">
            ${item.version}
          </div>
        `;
        deviceListEl.appendChild(div);
      });
    }

    function syncSelect(){
      deviceSelect.innerHTML = "";
      (catalog[activeCat]||[]).forEach(item=>{
        const opt = document.createElement("option");
        opt.textContent = `${item.name} — ${item.version}`;
        opt.value = item.manifest || "";
        opt.disabled = item.status!=="ready";
        deviceSelect.appendChild(opt);
      });
      const firstReady = Array.from(deviceSelect.options).find(o=>!o.disabled);
      if(firstReady){
        deviceSelect.value = firstReady.value;
        flashBtn.setAttribute("manifest", firstReady.value);
        flashActivate.disabled = false;
      }else{
        deviceSelect.value = "";
        flashBtn.setAttribute("manifest", "");
        flashActivate.disabled = true;
      }
    }

    deviceSelect.addEventListener("change", ()=>{
      const val = deviceSelect.value;
      flashBtn.setAttribute("manifest", val);
      flashActivate.disabled = !val;
    });

    renderTabs();
    renderDevices();
    syncSelect();

    // Re-check gate if user opens as app later
    window.matchMedia("(display-mode: standalone)").addEventListener("change", updateGate);
  </script>
</body>
</html>
